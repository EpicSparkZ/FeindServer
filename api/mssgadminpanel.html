<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control Page</title>
  <link rel="icon" href="/webicon.png" type="image/png">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #1e1e1e;
      color: white;
      padding: 40px;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 500px;
    }

    label {
      display: block;
      margin-bottom: 15px;
    }

    input, button, textarea {
      padding: 8px;
      font-size: 1rem;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #444;
      color: white;
      border: 1px solid #666;
      cursor: pointer;
      width: auto;
    }

    textarea {
      height: 80px;
      background-color: #2a2a2a;
      color: white;
      border: 1px solid #444;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>API Bot Admin Panel</h2>

    <label>
      <input type="checkbox" id="allowSwitch"> Allow Sending
    </label>

    <label>
      Normal Cooldown (seconds):
      <input type="number" id="cooldownInput" value="0" min="0">
    </label>

    <label>
      Ping Cooldown (seconds):
      <input type="number" id="pingCooldownInput" value="0" min="0">
    </label>

    <label>
      Max Pings Per Message:
      <input type="number" id="maxPingsInput" value="5" min="1">
    </label>

    <label>
      Optional Note:
      <textarea id="noteInput" placeholder="Add a note to include in the Discord message..."></textarea>
    </label>

    <button id="saveBtn">Save</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA2HyO5wSmAZPBjfFrShcS2EF1G9uFT9nk",
      authDomain: "feindserver-ee38e.firebaseapp.com",
      databaseURL: "https://feindserver-ee38e-default-rtdb.firebaseio.com",
      projectId: "feindserver-ee38e",
      storageBucket: "feindserver-ee38e.appspot.com",
      messagingSenderId: "612147980631",
      appId: "1:612147980631:web:699fec3b5ffa01d0ebb612"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const allowSwitch = document.getElementById('allowSwitch');
    const cooldownInput = document.getElementById('cooldownInput');
    const pingCooldownInput = document.getElementById('pingCooldownInput');
    const maxPingsInput = document.getElementById('maxPingsInput'); // NEW
    const noteInput = document.getElementById('noteInput');
    const saveBtn = document.getElementById('saveBtn');

    let previousSettings = {};
    let isSaving = false;

    // Load current settings from Firebase
    db.ref('control').on('value', snapshot => {
      const data = snapshot.val() || {};
      previousSettings = {
        allowMessages: data.allowMessages !== false,
        cooldown: Math.floor((data.cooldown || 0) / 1000),
        pingCooldown: Math.floor((data.pingCooldown || (data.cooldown || 0)) / 1000),
        maxPings: data.maxPings || 5 // NEW
      };
      allowSwitch.checked = previousSettings.allowMessages;
      cooldownInput.value = previousSettings.cooldown;
      pingCooldownInput.value = previousSettings.pingCooldown;
      maxPingsInput.value = previousSettings.maxPings;
    });

    saveBtn.addEventListener('click', async () => {
      if (isSaving) return;
      isSaving = true;

      const allow = allowSwitch.checked;
      const cooldown = parseInt(cooldownInput.value) || 0;
      const pingCooldown = parseInt(pingCooldownInput.value) || cooldown;
      const maxPings = parseInt(maxPingsInput.value) || 5; // NEW
      const note = noteInput.value.trim();

      // Check for changes and include old values
      const changes = [];
      if (allow !== previousSettings.allowMessages) changes.push(`Allow Sending: ${previousSettings.allowMessages} → ${allow}`);
      if (cooldown !== previousSettings.cooldown) changes.push(`Normal Cooldown: ${previousSettings.cooldown}s → ${cooldown}s`);
      if (pingCooldown !== previousSettings.pingCooldown) changes.push(`Ping Cooldown: ${previousSettings.pingCooldown}s → ${pingCooldown}s`);
      if (maxPings !== previousSettings.maxPings) changes.push(`Max Pings: ${previousSettings.maxPings} → ${maxPings}`); // NEW

      try {
        // Save to Firebase
        await db.ref('control').set({
          allowMessages: allow,
          cooldown: cooldown * 1000,
          pingCooldown: pingCooldown * 1000,
          maxPings: maxPings // NEW
        });

        // Send Discord message if there are changes or a note
        if (changes.length > 0 || note) {
          const webhookURL = "https://discord.com/api/webhooks/1462611630683853002/bq3KbE-StqlChYFWhDgoSee9FJYp7taH64GzjCpjmwgz9zDvhNnzdn51kyd6LrySnKal";
          let message = "Settings Updated:\n" + changes.join("\n");
          if (note) message += "\n\nNote: " + note;

          const res = await fetch(webhookURL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content: message })
          });

          if (!res.ok) throw new Error(`Discord returned status ${res.status}`);
          console.log("Discord message sent successfully!");
        }

        alert('Settings saved!');
        noteInput.value = ""; // Clear note after sending
      } catch (err) {
        console.error("Failed to save or send message:", err);
        alert("Error saving settings or sending Discord message. Check console.");
      } finally {
        isSaving = false;
      }
    });
  </script>

  <script>
  async function requireAccessCode() {
    try {
      // Pull the code from Firebase
      const snapshot = await db.ref('control/accessCode').get();
      const correctCode = snapshot.val(); // no fallback

      // If no code is set in Firebase, lock the page
      if (!correctCode) {
        alert("Access code not set. Page is locked.");
        document.querySelectorAll('input, button, textarea').forEach(el => {
          el.disabled = true;
        });
        return;
      }

      // Ask user for the code
      let enteredCode = prompt("Enter access code to use this page:");

      if (enteredCode !== correctCode) {
        alert("Incorrect code! You cannot use this page.");
        document.querySelectorAll('input, button, textarea').forEach(el => {
          el.disabled = true;
        });
      }
    } catch (err) {
      console.error("Error fetching access code from Firebase:", err);
      alert("Error fetching access code. Page is locked.");
      document.querySelectorAll('input, button, textarea').forEach(el => {
        el.disabled = true;
      });
    }
  }

  // Call the function after Firebase is initialized
  requireAccessCode();
</script>

</body>
</html>
