<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feind Server Messages</title>
  <link rel="icon" href="/webicon.png" type="image/png">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #1e1e1e; color: white; overflow-x: hidden; }
    .main-content { padding: 40px; max-width: 800px; box-sizing: border-box; }
    h1 { font-size: 2rem; margin-bottom: 20px; }
    p { line-height: 1.6; margin-bottom: 20px; }
    textarea, input { 
      width: 100%; 
      padding: 8px; 
      margin-top: 6px; 
      margin-bottom: 20px; 
      background-color: #2a2a2a; 
      color: white; 
      border: 1px solid #444; 
      font-family: inherit; 
      font-size: 1rem; 
      resize: none; /* Prevent user from resizing the textarea */
    }
    button { padding: 10px 20px; background-color: #444; color: white; border: 1px solid #666; cursor: pointer; }
    .selected-users { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
    .selected-user { background: #444; padding: 5px 10px; border-radius: 4px; display: inline-flex; align-items: center; gap: 5px; }
    .selected-user span { cursor: pointer; font-weight: bold; }
    #adminNoteBox { background: #333; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="main-content">
  <h1>Feind Server Messages</h1>
  <p>API Status: ðŸŸ¢</p>

  <!-- Admin Note Box -->
  <div id="adminNoteBox" style="display:none;">
    <p><strong>Messages are currently disabled by an administrator.</strong></p>
    <p><strong>Provided Note:</strong> <span id="adminNoteText"></span></p>
  </div>

  <form id="noteForm">
    <label>
      <strong>Message</strong><br>
      <textarea id="note" rows="5" placeholder="Type your message here..."></textarea>
    </label>

    <label>
      <strong>Ping User/s</strong><br>
      <input id="pingUserInput" list="userList" placeholder="Start typing a username...">
      <datalist id="userList"></datalist>
    </label>

    <div class="selected-users" id="selectedUsersContainer"></div>

    <button type="submit">Send</button>
  </form>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA2HyO5wSmAZPBjfFrShcS2EF1G9uFT9nk",
    authDomain: "feindserver-ee38e.firebaseapp.com",
    databaseURL: "https://feindserver-ee38e-default-rtdb.firebaseio.com",
    projectId: "feindserver-ee38e",
    storageBucket: "feindserver-ee38e.appspot.com",
    messagingSenderId: "612147980631",
    appId: "1:612147980631:web:699fec3b5ffa01d0ebb612"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const note = document.getElementById('note');
  const pingInput = document.getElementById('pingUserInput');
  const datalist = document.getElementById('userList');
  const selectedUsersContainer = document.getElementById('selectedUsersContainer');
  const form = document.getElementById('noteForm');
  const adminNoteBox = document.getElementById('adminNoteBox');
  const adminNoteText = document.getElementById('adminNoteText');

  let selectedUsers = [];
  let isSending = false;

  const userMap = {
    "EpicSparkZ": "941482778116120616",
    "Raptor": "830376717226475531",
    "Rutap": "781965040223780874",
    "Tonk": "667179181565542404",
    "zGray": "956638625116868662",
    "EggsAreGreat": "1148606556980650106",
    "Hogurts": "989062707917504512",
    "dddashy": "905896395645517844",
    "Flakey": "1462117336072065260",
    "Veno": "1101554384145485866",
    "Caketi": "1004042054944440371",
    "Galaxifard": "1144068676295872653",
    "FeindFighter": "1157795564457574410",
    "Predd": "1131758881538846740",
    "Orangss": "771937709551124510",
    "Vookey": "939296693562781877"
  };

  Object.keys(userMap).sort().forEach(u => {
    const opt = document.createElement('option');
    opt.value = u;
    datalist.appendChild(opt);
  });

  pingInput.addEventListener('change', () => {
    const username = pingInput.value.trim();
    if (!userMap[username]) { pingInput.value = ""; return; }
    if (selectedUsers.length >= 5) { alert("You can ping a maximum of 5 users."); pingInput.value = ""; return; }

    selectedUsers.push(username);
    renderSelectedUsers();
    pingInput.value = "";
  });

  function renderSelectedUsers() {
    selectedUsersContainer.innerHTML = "";
    selectedUsers.forEach((user, i) => {
      const div = document.createElement('div');
      div.className = 'selected-user';
      div.textContent = user;
      const span = document.createElement('span');
      span.textContent = 'âœ•';
      span.onclick = () => { selectedUsers.splice(i,1); renderSelectedUsers(); };
      div.appendChild(span);
      selectedUsersContainer.appendChild(div);
    });
  }

  note.addEventListener('input', function() {
    const lines = this.value.split('\n');
    if (lines.length > 15) this.value = lines.slice(0,15).join('\n');
  });

  // Listen for admin control changes
  db.ref("control").on("value", snap => {
    const data = snap.val() || {};
    const allow = data.allowMessages !== false;
    const noteText = (data.note || "").trim() || "N/A";

    form.querySelector('button').disabled = !allow;

    if (!allow) {
      adminNoteBox.style.display = "block";
      adminNoteText.textContent = noteText;
    } else {
      adminNoteBox.style.display = "none";
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (isSending) return;
    isSending = true;

    try {
      const snapshot = await db.ref("control").get();
      const control = snapshot.val() || {};
      const allowMessages = control.allowMessages !== false;
      const normalCooldown = control.cooldown || 0;
      const pingCooldown = control.pingCooldown || 0;

      if (!allowMessages) { alert("Sending is currently disabled."); return; }

      const now = Date.now();
      const lastMessageTime = parseInt(localStorage.getItem('lastMessageTime')) || 0;
      const lastPingTime = parseInt(localStorage.getItem('lastPingTime')) || 0;
      const hasPing = selectedUsers.length > 0;

      if (hasPing && now - lastPingTime < pingCooldown) {
        alert(`Please wait ${Math.ceil((pingCooldown - (now - lastPingTime))/1000)} seconds before sending another ping.`);
        return;
      }

      if (!hasPing && now - lastMessageTime < normalCooldown) {
        alert(`Please wait ${Math.ceil((normalCooldown - (now - lastMessageTime))/1000)} seconds before sending another message.`);
        return;
      }

      const pingText = selectedUsers.map(u => `<@${userMap[u]}>`).join(" ");
      const messageContent = (note.value.trim() ? note.value.trim() + (pingText ? " " : "") : "") + pingText;

      if (!messageContent) { alert("Please enter a message or select a user to ping."); return; }

      const webhookURL = "https://discord.com/api/webhooks/1462604278462939351/77_Xwp8KgaZlus_T0PMbqmUIhgPG41G1w5YYzXZ8XR6cdAIiKvFT3zdyBtuEP-VNGnyx";
      const res = await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: messageContent })
      });

      if (!res.ok) throw new Error(`Discord returned status ${res.status}`);

      alert("Message sent successfully!");
      form.reset();
      selectedUsers = [];
      renderSelectedUsers();

      if (hasPing) localStorage.setItem('lastPingTime', now);
      else localStorage.setItem('lastMessageTime', now);

    } catch (err) {
      console.error(err);
      alert("Failed to send message. Message may be too long or break a rule.");
    } finally { isSending = false; }
  });
</script>

</body>
</html>
